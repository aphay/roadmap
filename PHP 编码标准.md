PHP 编码标准
-------------------
这个文档举了几条程序员在编辑PHP源码时所应该遵守的规范标准。由于文档是在PHP v3.0开发后期才编撰的，所以源码并非完全符合这个文档中的标准，但是文档还是提供了一定的指导方向。现在我们正在开发版本5，很多地方会按照文档标准来重写。

编码实现
-------------------

0. 在源文件和手册中记录你的代码。 [tm]

1. 函数不应该释放传给他们的资源指针。

	举个栗子，``function int mail(char *to, char *from)`` **不可以** 释放to或from指针。
	
	特殊情况:
	- 函数是专门用于释放资源的。比如，``efree()``
	- 函数有一个boolean参数，专门用于控制是否释放资源。
	- 低级的解析器协程，集成了令牌缓存和bison代码，用于缩小内存复制开销

2. 相同模块内与其他函数紧密关联，并且依赖彼此行为的函数, 应当定义为``static``。如果可能，尽量必须使用它

3. 尽可能使用预定义与宏，使得常量可以有意义且更容易操纵。除非是使用0与1表示false和true的时候，否则应该使用 ``#define`` 来定义所有的数字常量

4. 当编写一个用来处理字符串的函数时，请记住PHP保存了每个字符串的 length 属性，这个属性不应当使用``strlen()``来计算。利用 length 属性来编写你的函数既可以确保效率，又可以确保二进制安全。函数在修改字符串时，也要一并维护 length 属性，使得它不需要使用``strlen()``重新计算。(比如，``php_addslashes()``)

5. **永远不要使用** ``strncat()``。如果你确切知道你在做什么，请再次检查man文档，介时再考虑是否使用``strncat()``。尽管如此，还是请忽略这个函数。(看了文档，估计是容易造成溢出)

6. 在PHP源码中使用 ``PHP_*`` 宏， 在Zend源码中使用 ``ZEND_*`` 宏，虽然 ``ZEND_*`` 是 ``PHP_*`` 的别名，但区分使用可以让人更好理解。

7. 当使用``#if``注释代码时，**不要只用** 0，而是使用 ``<git username here>_0``。比如，``#if FOO_0``，``FOO``是你的git用户名。这样可以方便的追踪到代码为何被注释，特别是在附加库中。

8. 不要定义不可访问的函数，比如，如果一个库找不到某个函数，不要定义PHP版本的函数，也不要抛出一个运行时错误。终端用户应该使用``function_exists()``来检测函数是否存在。

9. 使用 ``emalloc()``，``efree()``，``estrdup()``等，而不使用标准C库中的函数。 这些函数实现了内部一个内部安全机制，确保请求结束时对没有释放的内存进行释放。同时它们在调试模式下也可以显示出内存的分配与溢出信息。

    在大多数情况下，内存的分配也应该由``emalloc()``完成。

    ``malloc()`` 的使用应该仅限于在需要控制内存的第三方库中，或者在多次请求中需要保留内存的场景下。

用户函数/方法命名公约
------------------

1. 用户级函数的名称应该被包含在 ``PHP_FUNCTION()`` 宏中。 函数名要求全部小写，使用下划线分隔连接，注意函数名长度尽量精简。不要使用会影响可读性的简写:

    正面例子:
    
    ```
    mcrypt_enc_self_test
    mysql_list_fields
    ```

    还OK的例子:
    
    ```
    mcrypt_module_get_algo_supported_key_sizes
    (mcrypt_mod_get_algo_sup_key_sizes 可以么？)(问谁呢？)
    get_html_translation_table
    (html_get_trans_table 可以么？)
	```

    反面例子:
    
    ```
    hw_GetObjectByQueryCollObj
    pg_setclientencoding
    jf_n_s_i
    ```
2. 如果函数隶属于某一个“父集”，使用“父集”名称做为函数名的前缀。比如 ``parent_*``:

    对于 foo 家族的函数而言:
    
    正面例子:
    
    ```
    foo_select_bar
    foo_insert_baz
    foo_delete_baz
    ```
	 
    反面例子:
    
    ```
    fooselect_bar
    fooinsertbaz
    delete_foo_baz
    ```
3. 用户级函数的名称需要使用 ``_php_`` 作为前缀，并紧接一个或一系列由下划线分隔的小写词, 用来描述函数名。如果可以，应将它们定义为 `static`。

4. 变量名应该有意义。只有一个字母的变量名应该避免，除非它并没有实际意义，或者意义不重要(比如，``for (i=0; i<100; i++)`` ...)。

5. 变量名要小写，使用下划线分隔。

6. 方法名要用“驼峰”式命名，并且要精简。首字母小写，新单词首字母大写。

   正面例子:
    
   ```
   connect()
   getData()
   buildSomeWidget()
   ```

   反面例子:
    
   ```
   get_Data()
   buildsomewidget()
   getI()
   ```

7. 类名应该具有描述性。避免使用缩写。类名中的每个首字母要大写，不能使用下划线分隔单词。类名使用父集合的名称作为前缀(比如，扩展的名称)：

   正面例子:
    
	```
   Curl
   FooBar
   	```

   反面例子:
   
   ```
   foobar
   foo_bar
   ```
   
内部函数命名公约
----------------------

1. 属于外部API部分的函数应该命名为 ``php_modulename_function()`` ，以避免符号冲突。函数名应该小写，使用下划线分隔。暴露给外面的API应当在 php_modulename.h 中定义。

	```
	PHPAPI char *php_session_create_id(PS_CREATE_SID_ARGS);
	```

	非暴露模块的函数应该是静态的，且不应该在 php_modulename.h 中定义。

	```
	static int php_session_destroy(TSRMLS_D)
	```

2. 模块主文件名为 modulename.c。

3. 用于其他源码的头文件命名为 php_modulename.h。


语法与缩进
----------------------

1. 不要使用C++风格的注释 (即 // comment)，使用C语言风格的注释。PHP是C语言写的，并且是基于ANSI-C兼容的编译器进行编译的。即使很多编译器能够接受C文件中的C++风格的注释，你也要确保你的代码可以被其他的编译器编译。唯一的例外是Win32下的代码。因为Win32的特别的编译器是MS-Visual C++，它是已知的可以在C代码中兼容C++风格注释的。

2. 使用K&R风格 (所谓K&R即指《The C Programming Language》一书的作者Kernighan和Ritchie二人，这是世界上第一本介绍C语言的书，而K&R风格即指他们在该书中书写代码所使用的风格。K&R风格在处理大括号时，**将左括号留在前一行的末尾**)。 当然我们不能，也不想强迫任何人使用他们不习惯用的风格，但是，至少在你编写PHP核心代码或是它的标准模块时，请保持K&R风格。这一要求是针对所有编码风格，包括缩进，注释以至于函数声明语法。参考缩进风格：[Indentstyle](http://www.catb.org/~esr/jargon/html/I/indent-style.html)

3. 不要省略空格与花括号。确保不同组的变量声明之间有一个空行，对于被封装在某一代码块中语句也一样。同样对于一个块中的逻辑声明。确保两个函数之间能有至少一个空行，最好两行。

	正面例子:
	
	```
	if (foo) {
		bar;
	}
	```
	
   反面例子:

	```
	if(foo)bar;
	```

4. 缩进时使用 tab。一个 tab 等于4个空格。确保缩进的一致性很重要，因为要保证声明，注释，控制结构的正确对齐。

5. 预处理声明 (#if 等) **一定要** 在最左侧。如果要缩进预处理器，应该把 # 放在最左侧，然后接任意数量的空格。

测试
-------

1. 扩展应该使用 \*.phpt 文件进行详细的单测。参考 README.TESTING。

文档与折叠点
-------------------------------

为了确保在线文档与代码保持一致，每个用户级的函数都要有原型，然后接着一句简短描述，表明函数是做什么的。参考:

	```
	/* {{{ proto int abs(int number)
		Returns the absolute value of the number */
	PHP_FUNCTION(abs)
	{
		...
	}
	/* }}} */
	```

``{{{`` 符号是 Emacs 和 vim(set fdm=marker) 中的折叠模式的默认折叠符。处理大文件时折叠很有用，因为你快速浏览文件，并专注于处理未折叠的函数。``}}}`` 是折叠的结束位置，需要换行。

"proto" 关键字是用于辅助doc/genfuncsummary脚本生成所有函数摘要。在函数原型前加入这个关键字使我们在折叠时不会混淆函数摘要。

可选参数的表示方法:

	```
	/* {{{ proto object imap_header(int stream_id, int msg_no [, int from_length [, int subject_length [, string default_host]]])
		Returns a header object with the defined parameters */
	```
	
原型应该保持在一行中，即使这一行很大。

新的实验性函数
-----------------------------------
为了减少由于首次公有函数集所引起的问题，我们建议在函数目录下建立一个 EXPERIMENTAL 文件，并且函数在首次实现时其命名应该遵循标准前缀公约。

EXPERIMENTAL 文件应该包含以下信息:

* 所有编码相关信息 (已知bug，未来演化方向)
* 不适合记录在git备注上的进行中的开发动态。

一般来说，新功能应该放到pecl上，或者实验分支，直到因为某些原因必须合并到核心代码中。

别名 & 前人文档
-----------------------------------
对于重复的名称，你可能会有些弃用的别名，比如 somedb\_select\_result 与 somedb\_selectresult。出于编写文档的需要，应该只保留最新使用中的名称，其他别名在父函数中列举出来。为了便于参考，一个用户函数如果拥有多个完成不同的别名 (比如
highlight\_file 和 show\_source) ，则应该分开编写文档。原型依然要保留，表示是哪个函数的别名。

向后兼容的函数与命名应确保可以被合理的收录在代码库中 更多信息参考 /phpdoc/README 。
